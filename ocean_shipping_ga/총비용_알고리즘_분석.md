# 🚢 해상 운송 GA 최적화 - 총비용 알고리즘 분석

## 📋 개요

이 문서는 해상 운송 최적화를 위한 유전 알고리즘(GA)에서 **총비용 계산 알고리즘**이 세대가 지나면서 어떻게 작동하는지 상세히 분석합니다.

## 🧬 GA 최적화 과정에서의 비용 계산

### 1. 세대별 비용 계산 시점

```python
# ga_optimizer.py의 run() 메서드에서
if generation % 100 == 0:  # 100세대마다 상세 비용 정보 출력
    total_cost = self.fitness_calculator.calculate_total_cost(best)
    penalty = self.fitness_calculator.calculate_penalties(best)
    print(f"  ├─ 총 비용: ${total_cost:,.0f}")
    print(f"  ├─ 패널티: {penalty:.0f}")
    print(f"  └─ Full/Empty: {np.sum(best['xF']):.0f}/{np.sum(best['xE']):.0f} TEU")
```

**비용 계산 빈도:**
- **매 세대**: 적합도 계산 시 내부적으로 비용 계산
- **100세대마다**: 상세 비용 정보 출력
- **개선 시**: 즉시 비용 정보 출력

### 2. 총비용 계산 공식

#### 📊 기본 비용 구성요소

```python
def calculate_total_cost(self, individual: Dict[str, Any]) -> float:
    """총 비용 계산"""
    total_cost = 0
    
    for idx, i in enumerate(self.params.I):
        # 1. 운송 비용 (Full 컨테이너)
        base_cost = self.params.CSHIP + self.params.CBAF
        delay_penalty = self.params.CETA * self.params.DELAY_i.get(i, 0)
        total_cost += (base_cost + delay_penalty) * individual['xF'][idx]
        
        # 2. 빈 컨테이너 운송 비용
        total_cost += self.params.CEMPTY_SHIP * individual['xE'][idx]
    
    return total_cost
```

#### 💰 비용 파라미터 상세

| 파라미터 | 설명 | 단위 | 설정 위치 |
|---------|------|------|-----------|
| `CSHIP` | 기본 운송비 | USD/TEU | 고정값 데이터 |
| `CBAF` | 유류할증료 | USD/TEU | 고정값 데이터 |
| `CETA` | ETA 지연 패널티 | USD/일 | 고정값 데이터 |
| `CEMPTY_SHIP` | 빈 컨테이너 운송비 | USD/TEU | `CSHIP + CBAF` |

### 3. 세대별 비용 변화 추적

#### 🔍 비용 계산 흐름도

```
세대 시작
    ↓
적합도 계산 (calculate_fitness)
    ↓
총비용 계산 (calculate_total_cost)
    ↓
패널티 계산 (calculate_penalties)
    ↓
최종 적합도 = -(총비용 + 패널티)
    ↓
선택 연산 (selection)
    ↓
교차/변이 연산 (crossover/mutation)
    ↓
새 세대 생성
    ↓
100세대마다 비용 정보 출력
```

#### 📈 세대별 비용 모니터링

```python
# 세대 통계 저장
generation_stat = {
    'generation': generation,
    'best_fitness': best['fitness'],
    'diversity': diversity,
    'mutation_rate': current_mutation_rate,
    'improvement': improvement
}
self.params.generation_stats.append(generation_stat)
```

## 🎯 비용 최적화 전략

### 1. 적응적 돌연변이율

```python
# 다양성에 따른 변이율 조정
current_mutation_rate = self.genetic_operators.adaptive_mutation_rate(generation, diversity)
self.params.p_mutation = current_mutation_rate
```

**전략:**
- **높은 다양성**: 낮은 변이율로 안정화
- **낮은 다양성**: 높은 변이율로 탐색 강화

### 2. 수렴 감지 및 조기 종료

```python
# 수렴 감지
if stagnation_counter >= self.params.convergence_patience:
    print(f"\n⏹️ 수렴 감지로 조기 종료 (세대 {generation})")
    print(f"   {self.params.convergence_patience}세대 동안 {self.params.convergence_threshold*100:.2f}% 이상 개선 없음")
    break
```

**수렴 조건:**
- `convergence_patience`: 수렴 대기 세대 수
- `convergence_threshold`: 개선 임계값 (%)

## 📊 비용 구성 요소별 분석

### 1. Full 컨테이너 비용

```python
# Full 컨테이너당 비용
full_cost_per_teu = CSHIP + CBAF + (CETA × DELAY_i)
total_full_cost = Σ(full_cost_per_teu × xF[i])
```

**비용 요소:**
- **기본 운송비**: `CSHIP` (고정)
- **유류할증료**: `CBAF` (고정)
- **지연 패널티**: `CETA × DELAY_i` (가변)

### 2. Empty 컨테이너 비용

```python
# Empty 컨테이너당 비용
empty_cost_per_teu = CEMPTY_SHIP = CSHIP + CBAF
total_empty_cost = Σ(empty_cost_per_teu × xE[i])
```

**특징:**
- 지연 패널티 없음
- 기본 운송비 + 유류할증료만 적용

### 3. 지연 패널티 계산

```python
# 지연일수 계산
self.DELAY_i = {}
for i in self.I:
    if i in self.RETA_i and i in self.ETA_i:
        delay = (self.RETA_i[i] - self.ETA_i[i]).days
        self.DELAY_i[i] = max(0, delay)  # 음수 방지
    else:
        self.DELAY_i[i] = 0
```

**지연 패널티 특징:**
- 실제 지연일수만 계산
- 음수 지연은 0으로 처리
- Full 컨테이너에만 적용

## 🔄 세대별 비용 최적화 과정

### 1. 초기 세대 (0-100)

**특징:**
- 높은 다양성으로 인한 비용 편차 큼
- 제약 조건 위반으로 인한 높은 패널티
- 기본 비용 구조 탐색

**출력 예시:**
```
세대    0: 적합도= -1250000.00 | 다양성= 85.23 | 변이율=0.100 | 정체=  0 | 0.1s
  ├─ 총 비용: $1,250,000
  ├─ 패널티: 50000
  └─ Full/Empty: 8500/1500 TEU
```

### 2. 중간 세대 (100-500)

**특징:**
- 점진적 비용 개선
- 제약 조건 위반 감소
- 패널티 비용 최소화

**출력 예시:**
```
세대  200: 적합도= -980000.00 | 다양성= 65.45 | 변이율=0.075 | 정체=  0 | 45.2s
  ├─ 총 비용: $980,000
  ├─ 패널티: 15000
  └─ Full/Empty: 8200/1800 TEU
```

### 3. 후기 세대 (500+)

**특징:**
- 비용 수렴 및 안정화
- 낮은 다양성으로 인한 세밀한 조정
- 최적 비용 구조 발견

**출력 예시:**
```
세대  600: 적합도= -920000.00 | 다양성= 45.67 | 변이율=0.050 | 정체= 15 | 120.5s
  ├─ 총 비용: $920,000
  ├─ 패널티: 5000
  └─ Full/Empty: 8000/2000 TEU
```

## 📈 비용 최적화 성과 지표

### 1. 절대적 개선

```python
# 개선률 계산
if best_individual is not None:
    improvement_rate = (best['fitness'] - best_individual['fitness']) / abs(best_individual['fitness'])
    if improvement_rate > self.params.convergence_threshold:
        improvement = True
        stagnation_counter = 0
```

**개선 기준:**
- `convergence_threshold`: 개선 임계값 (기본값: 0.01 = 1%)
- 1% 이상 개선 시 정체 카운터 리셋

### 2. 상대적 개선

```python
# 세대별 적합도 변화
best_fitness_history.append(best['fitness'])

# 최종 결과
print(f"🏆 최종 적합도: {best_individual['fitness']:.2f}")
print(f"📈 총 진화 세대: {generation + 1}")
```

## 🎯 비용 최적화 핵심 인사이트

### 1. **비용 구조의 복잡성**
- 단순한 선형 비용이 아닌 다층적 비용 구조
- 지연 패널티가 전체 비용에 미치는 영향이 큼
- Full/Empty 컨테이너 비율이 비용 효율성 결정

### 2. **제약 조건의 중요성**
- 패널티 비용이 실제 운송 비용보다 클 수 있음
- 제약 조건 만족이 비용 최적화의 핵심
- 용량 제약과 수요 충족의 균형이 중요

### 3. **세대별 최적화 전략**
- 초기: 제약 조건 위반 최소화
- 중기: 비용 구조 최적화
- 후기: 세밀한 조정과 수렴

## 🔧 비용 계산 최적화 팁

### 1. **파라미터 튜닝**
```python
# 비용 파라미터 조정
self.params.CETA = 200  # 지연 패널티 증가
self.params.CBAF = 150  # 유류할증료 증가
```

### 2. **제약 조건 가중치 조정**
```python
# 패널티 가중치 조정
demand_penalty += abs(total_full - demand) * 3000  # 수요 충족 가중치 증가
capacity_penalty += (total_containers - capacity) * 2000  # 용량 제약 가중치 증가
```

### 3. **수렴 조건 최적화**
```python
# 수렴 파라미터 조정
self.params.convergence_patience = 200  # 더 오래 대기
self.params.convergence_threshold = 0.005  # 더 엄격한 개선 기준
```

## 📊 결론

해상 운송 GA 최적화에서 총비용 알고리즘은 **세대별로 지속적인 모니터링과 최적화**를 통해 작동합니다. 

**핵심 특징:**
1. **실시간 비용 추적**: 매 세대마다 비용 계산 및 기록
2. **적응적 최적화**: 다양성과 변이율을 통한 지능적 탐색
3. **제약 조건 통합**: 비용과 제약 조건의 균형적 최적화
4. **수렴 감지**: 효율적인 조기 종료로 계산 시간 단축

이러한 체계적인 비용 최적화 과정을 통해 해상 운송의 비용 효율성을 극대화할 수 있습니다.
